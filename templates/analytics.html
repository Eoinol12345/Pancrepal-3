{% extends "base.html" %}

{% block title %}Advanced Analytics{% endblock %}

{% block content %}
<div class="analytics-page">
    <h1 class="page-title">Advanced Analytics</h1>
    <p class="page-subtitle">Deep insights into your glucose management</p>

    <!-- Period Selector -->
    <div class="period-selector">
        <a href="{{ url_for('analytics', days=14) }}"
           class="period-btn {% if days == 14 %}active{% endif %}">14 Days</a>
        <a href="{{ url_for('analytics', days=30) }}"
           class="period-btn {% if days == 30 %}active{% endif %}">30 Days</a>
        <a href="{{ url_for('analytics', days=60) }}"
           class="period-btn {% if days == 60 %}active{% endif %}">60 Days</a>
        <a href="{{ url_for('analytics', days=90) }}"
           class="period-btn {% if days == 90 %}active{% endif %}">90 Days</a>
    </div>

    <!-- ================================================================
         US-23: KEY PERFORMANCE INDICATORS
         ================================================================ -->
    <section class="analytics-metrics">
        <h2 class="section-title">Key Performance Indicators</h2>

        <div class="analytics-grid">
            {% for key, explanation in explanations.items() %}
            {% if key == 'time_in_range' %}
            <div class="analytics-card analytics-primary">
                <div class="analytics-header">
                    <span class="analytics-icon">{{ explanation.icon }}</span>
                    <h3>{{ explanation.title }}</h3>
                </div>
                <div class="analytics-value">{{ metrics.time_in_range_pct }}%</div>
                <div class="analytics-target">Target: {{ explanation.target }}</div>
                <div class="analytics-description">{{ explanation.description }}</div>
            </div>
            {% elif key == 'avg_glucose' %}
            <div class="analytics-card">
                <div class="analytics-header">
                    <span class="analytics-icon">{{ explanation.icon }}</span>
                    <h3>{{ explanation.title }}</h3>
                </div>
                <div class="analytics-value">{{ metrics.mean_glucose }} mmol/L</div>
                <div class="analytics-target">Target: {{ explanation.target }}</div>
                <div class="analytics-description">{{ explanation.description }}</div>
            </div>
            {% elif key == 'coefficient_of_variation' %}
            <div class="analytics-card">
                <div class="analytics-header">
                    <span class="analytics-icon">{{ explanation.icon }}</span>
                    <h3>{{ explanation.title }}</h3>
                </div>
                <div class="analytics-value">{{ metrics.coefficient_of_variation }}%</div>
                <div class="analytics-target">Target: {{ explanation.target }}</div>
                <div class="analytics-description">{{ explanation.description }}</div>
            </div>
            {% elif key == 'hypo_events' %}
            <div class="analytics-card analytics-warning">
                <div class="analytics-header">
                    <span class="analytics-icon">{{ explanation.icon }}</span>
                    <h3>{{ explanation.title }}</h3>
                </div>
                <div class="analytics-value">{{ metrics.hypo_events }}</div>
                <div class="analytics-target">{{ metrics.time_below_range_pct }}% of readings</div>
                <div class="analytics-description">{{ explanation.description }}</div>
            </div>
            {% elif key == 'hyper_events' %}
            <div class="analytics-card analytics-info">
                <div class="analytics-header">
                    <span class="analytics-icon">{{ explanation.icon }}</span>
                    <h3>{{ explanation.title }}</h3>
                </div>
                <div class="analytics-value">{{ metrics.hyper_events }}</div>
                <div class="analytics-target">{{ metrics.time_above_range_pct }}% of readings</div>
                <div class="analytics-description">{{ explanation.description }}</div>
            </div>
            {% elif key == 'avg_daily_carbs' and metrics.avg_daily_carbs %}
            <div class="analytics-card analytics-carbs">
                <div class="analytics-header">
                    <span class="analytics-icon">{{ explanation.icon }}</span>
                    <h3>{{ explanation.title }}</h3>
                </div>
                <div class="analytics-value">{{ metrics.avg_daily_carbs }}g</div>
                <div class="analytics-target">{{ metrics.entries_with_carbs }} entries tracked</div>
                <div class="analytics-description">{{ explanation.description }}</div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </section>

    <!-- ================================================================
         US-27: TIME-OF-DAY ANALYSIS
         ================================================================ -->
    <section class="tod-section">
        <h2 class="section-title">‚è∞ Time-of-Day Analysis</h2>
        <p class="section-subtitle">
            See how your glucose control varies throughout the day.
            Each period groups readings by time to reveal your strongest and weakest windows.
        </p>

        <!-- Period Cards -->
        <div class="tod-grid">
            {% for period_key in ['morning', 'afternoon', 'evening', 'night'] %}
            {% set p = time_analysis[period_key] %}
            <div class="tod-card {% if p.has_data %}tod-card--active{% endif %} tod-{{ period_key }}">
                <div class="tod-header">
                    <span class="tod-icon">{{ p.icon }}</span>
                    <div>
                        <h3 class="tod-label">{{ p.label }}</h3>
                        <span class="tod-time-range">{{ p.time_range }}</span>
                    </div>
                    {% if p.has_data %}
                    <span class="tod-count">{{ p.count }} readings</span>
                    {% endif %}
                </div>

                {% if p.has_data %}
                <div class="tod-metrics">
                    <!-- TIR Bar -->
                    <div class="tod-tir-row">
                        <span class="tod-metric-label">Time in Range</span>
                        <div class="tod-bar-wrap">
                            <div class="tod-bar" style="width: {{ p.time_in_range_pct }}%">
                                <span class="tod-bar-label">{{ p.time_in_range_pct }}%</span>
                            </div>
                        </div>
                    </div>

                    <div class="tod-stats-row">
                        <div class="tod-stat">
                            <span class="tod-stat-value">{{ p.avg_glucose }}</span>
                            <span class="tod-stat-label">Avg mmol/L</span>
                        </div>
                        <div class="tod-stat tod-stat--low">
                            <span class="tod-stat-value">{{ p.hypo_pct }}%</span>
                            <span class="tod-stat-label">Below range</span>
                        </div>
                        <div class="tod-stat tod-stat--high">
                            <span class="tod-stat-value">{{ p.hyper_pct }}%</span>
                            <span class="tod-stat-label">Above range</span>
                        </div>
                        {% if p.avg_carbs %}
                        <div class="tod-stat tod-stat--carbs">
                            <span class="tod-stat-value">{{ p.avg_carbs }}g</span>
                            <span class="tod-stat-label">Avg carbs</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="tod-no-data">
                    <span>No readings logged during this period yet.</span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- TIR Comparison Chart -->
        {% if tod_chart.labels %}
        <div class="tod-chart-wrap">
            <h3 class="subsection-title">Time-in-Range Comparison Across Periods</h3>
            <div class="tod-chart-container">
                <canvas id="todChart"></canvas>
            </div>
        </div>
        {% endif %}
    </section>

    <!-- ================================================================
         US-25: INSIGHT ENGINE
         ================================================================ -->
    <section class="insights-engine-section">
        <div class="insights-header-row">
            <h2 class="section-title">üîç Insight Engine</h2>
            <span class="insights-badge">{{ insights | length }} insight{{ 's' if insights | length != 1 }}</span>
        </div>
        <p class="section-subtitle">
            Automatically detected patterns from your recent logs,
            explained in plain language to help you understand your data.
        </p>

        <!-- Educational disclaimer ‚Äî always visible -->
        <div class="insight-disclaimer">
            <span class="disclaimer-icon">‚ÑπÔ∏è</span>
            <div>
                <strong>Educational tool only.</strong>
                These insights are generated automatically from your logged data and are
                intended to help you notice patterns and start conversations with your
                healthcare team. They are <strong>not medical advice, a diagnosis, or a
                treatment recommendation</strong>. Always consult your diabetes care team
                before making any changes to your management plan.
            </div>
        </div>

        {% if insights %}
        <div class="insights-list">
            {% for insight in insights %}
            <div class="insight-card insight-{{ insight.severity }}">
                <div class="insight-icon-wrap">
                    <span class="insight-big-icon">{{ insight.icon }}</span>
                    <span class="insight-severity-badge insight-badge-{{ insight.severity }}">
                        {% if insight.severity == 'warning' %}Worth noting
                        {% elif insight.severity == 'info' %}Pattern found
                        {% else %}Strength
                        {% endif %}
                    </span>
                </div>
                <div class="insight-body">
                    <h3 class="insight-title">{{ insight.title }}</h3>
                    <p class="insight-message">{{ insight.message }}</p>
                    <div class="insight-action">
                        <span class="action-label">üí° Suggestion:</span>
                        <span class="action-text">{{ insight.action }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="insights-empty">
            <span class="insights-empty-icon">üìä</span>
            <p>Keep logging! The Insight Engine needs at least 7 readings to detect patterns.</p>
            <p class="insights-empty-sub">The more you log, the more personalised your insights become.</p>
        </div>
        {% endif %}
    </section>

    <!-- Patterns Section (US-23, unchanged) -->
    {% if patterns %}
    <section class="patterns-section">
        <h2 class="section-title">Recurring Patterns</h2>
        <div class="patterns-list">
            {% for pattern in patterns %}
            <div class="pattern-card pattern-{{ pattern.severity }}">
                <div class="pattern-message">{{ pattern.message }}</div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Suggestion (US-23, unchanged) -->
    {% if suggestion %}
    <section class="suggestion-section">
        <h2 class="section-title">Personalised Suggestion</h2>
        <div class="suggestion-card">
            <p class="suggestion-text">{{ suggestion }}</p>
        </div>
    </section>
    {% endif %}

    <!-- Summary Stats -->
    <section class="summary-section">
        <h2 class="section-title">Summary Statistics ({{ days }} days)</h2>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-label">Total Readings</div>
                <div class="summary-value">{{ metrics.total_readings }}</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Standard Deviation</div>
                <div class="summary-value">{{ metrics.std_dev }} mmol/L</div>
            </div>
            {% if metrics.total_carbs > 0 %}
            <div class="summary-item">
                <div class="summary-label">Total Carbs Tracked</div>
                <div class="summary-value">{{ metrics.total_carbs }}g</div>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Actions -->
    <div class="analytics-actions">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        {% if not is_demo %}
        <a href="{{ url_for('export_csv', days=days) }}" class="btn btn-primary">üìä Export CSV</a>
        {% endif %}
    </div>
</div>


<style>
/* ============================================================
   ANALYTICS PAGE ‚Äî BASE
   ============================================================ */
.analytics-page {
    max-width: 1200px;
    margin: 0 auto;
}

.page-subtitle, .section-subtitle {
    color: #7f8c8d;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

/* Period selector */
.period-selector {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.period-btn {
    padding: 0.5rem 1.25rem;
    border: 2px solid #e0e6ed;
    border-radius: 9999px;
    text-decoration: none;
    color: #7f8c8d;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.15s ease;
}

.period-btn:hover, .period-btn.active {
    border-color: #4A90E2;
    background: #4A90E2;
    color: white;
}

/* ============================================================
   KPI CARDS (US-23, unchanged styles)
   ============================================================ */
.analytics-metrics {
    margin-bottom: 3rem;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.analytics-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 4px solid #4A90E2;
}
.analytics-card.analytics-primary  { border-left-color: #5CB85C; background: linear-gradient(135deg,rgba(92,184,92,.05),white); }
.analytics-card.analytics-warning  { border-left-color: #D9534F; background: linear-gradient(135deg,rgba(217,83,79,.05),white); }
.analytics-card.analytics-info     { border-left-color: #F0AD4E; background: linear-gradient(135deg,rgba(240,173,78,.05),white); }
.analytics-card.analytics-carbs    { border-left-color: #F0AD4E; background: linear-gradient(135deg,rgba(240,173,78,.05),white); }

.analytics-header { display:flex; align-items:center; gap:.75rem; margin-bottom:1rem; }
.analytics-icon   { font-size:2rem; }
.analytics-header h3 { font-size:1rem; font-weight:600; color:#2C3E50; margin:0; }
.analytics-value  { font-size:2.5rem; font-weight:700; color:#4A90E2; margin-bottom:.5rem; }
.analytics-target { font-size:.875rem; color:#7F8C8D; margin-bottom:1rem; }
.analytics-description { font-size:.875rem; color:#2C3E50; line-height:1.5; }

/* ============================================================
   US-27: TIME-OF-DAY SECTION
   ============================================================ */
.tod-section {
    margin-bottom: 3rem;
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.tod-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.25rem;
    margin-top: 1.5rem;
}

.tod-card {
    border-radius: 12px;
    padding: 1.25rem;
    border: 2px solid #e0e6ed;
    background: #f8f9fa;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.tod-card--active:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

/* Period accent colours */
.tod-morning   { border-color: rgba(255,186,73,0.6);  background: linear-gradient(135deg,rgba(255,186,73,.06),white); }
.tod-afternoon { border-color: rgba(74,144,226,0.6);  background: linear-gradient(135deg,rgba(74,144,226,.06),white); }
.tod-evening   { border-color: rgba(155,89,182,0.6);  background: linear-gradient(135deg,rgba(155,89,182,.06),white); }
.tod-night     { border-color: rgba(52,73,94,0.5);    background: linear-gradient(135deg,rgba(52,73,94,.06),white); }

.tod-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.tod-icon  { font-size: 1.75rem; flex-shrink: 0; }
.tod-label { font-size: 1.1rem; font-weight: 700; color: #2C3E50; margin: 0 0 2px 0; }
.tod-time-range { font-size: 0.8rem; color: #7f8c8d; }
.tod-count {
    margin-left: auto;
    font-size: 0.75rem;
    font-weight: 600;
    color: #7f8c8d;
    background: rgba(0,0,0,0.06);
    padding: 0.25rem 0.6rem;
    border-radius: 9999px;
    white-space: nowrap;
}

/* TIR bar */
.tod-tir-row {
    margin-bottom: 0.75rem;
}

.tod-metric-label {
    font-size: 0.78rem;
    font-weight: 600;
    color: #7f8c8d;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    display: block;
    margin-bottom: 0.4rem;
}

.tod-bar-wrap {
    background: #e0e6ed;
    border-radius: 9999px;
    height: 14px;
    overflow: hidden;
}

.tod-bar {
    height: 100%;
    background: linear-gradient(90deg, #5CB85C, #4A90E2);
    border-radius: 9999px;
    min-width: 2px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 6px;
    transition: width 0.6s ease;
}

.tod-bar-label {
    font-size: 0.7rem;
    font-weight: 700;
    color: white;
    white-space: nowrap;
}

/* Stat row */
.tod-stats-row {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
}

.tod-stat {
    flex: 1;
    min-width: 55px;
    text-align: center;
    background: rgba(0,0,0,0.04);
    border-radius: 8px;
    padding: 0.4rem 0.25rem;
}

.tod-stat-value {
    display: block;
    font-size: 1.1rem;
    font-weight: 700;
    color: #2C3E50;
}

.tod-stat-label {
    display: block;
    font-size: 0.68rem;
    color: #7f8c8d;
    margin-top: 2px;
}

.tod-stat--low  .tod-stat-value { color: #D9534F; }
.tod-stat--high .tod-stat-value { color: #F0AD4E; }
.tod-stat--carbs .tod-stat-value { color: #9B59B6; }

.tod-no-data {
    text-align: center;
    color: #aab3bb;
    font-size: 0.875rem;
    padding: 1rem 0;
    font-style: italic;
}

/* ToD Chart */
.tod-chart-wrap {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e0e6ed;
}

.tod-chart-container {
    position: relative;
    height: 240px;
    max-width: 700px;
    margin: 1rem auto 0;
}

/* ============================================================
   US-25: INSIGHT ENGINE SECTION
   ============================================================ */
.insights-engine-section {
    margin-bottom: 3rem;
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.insights-header-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.insights-badge {
    background: #4A90E2;
    color: white;
    font-size: 0.8rem;
    font-weight: 700;
    padding: 0.2rem 0.75rem;
    border-radius: 9999px;
}

/* Disclaimer */
.insight-disclaimer {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    background: rgba(74,144,226,0.07);
    border: 1px solid rgba(74,144,226,0.25);
    border-radius: 10px;
    padding: 1rem 1.25rem;
    margin: 1.25rem 0 1.75rem;
    font-size: 0.875rem;
    color: #2C3E50;
    line-height: 1.6;
}

.disclaimer-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
    margin-top: 1px;
}

/* Insight cards */
.insights-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.insight-card {
    display: flex;
    gap: 1.25rem;
    padding: 1.25rem 1.5rem;
    border-radius: 12px;
    border-left: 5px solid #e0e6ed;
    background: #f8f9fa;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.insight-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.insight-card.insight-warning {
    border-left-color: #F0AD4E;
    background: linear-gradient(135deg,rgba(240,173,78,.06),#fff);
}

.insight-card.insight-info {
    border-left-color: #4A90E2;
    background: linear-gradient(135deg,rgba(74,144,226,.06),#fff);
}

.insight-card.insight-success {
    border-left-color: #5CB85C;
    background: linear-gradient(135deg,rgba(92,184,92,.06),#fff);
}

.insight-icon-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
    min-width: 56px;
}

.insight-big-icon { font-size: 2rem; }

.insight-severity-badge {
    font-size: 0.65rem;
    font-weight: 700;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    text-align: center;
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.insight-badge-warning { background:#fff3cd; color:#856404; }
.insight-badge-info    { background:#cfe2ff; color:#084298; }
.insight-badge-success { background:#d1e7dd; color:#0a3622; }

.insight-body { flex: 1; }

.insight-title {
    font-size: 1.05rem;
    font-weight: 700;
    color: #2C3E50;
    margin: 0 0 0.5rem;
}

.insight-message {
    color: #4a5568;
    font-size: 0.9rem;
    line-height: 1.65;
    margin-bottom: 0.75rem;
}

.insight-action {
    font-size: 0.875rem;
    background: rgba(0,0,0,0.04);
    border-radius: 8px;
    padding: 0.6rem 0.85rem;
    line-height: 1.5;
}

.action-label {
    font-weight: 700;
    color: #2C3E50;
    margin-right: 0.4rem;
}

.action-text { color: #4a5568; }

/* Empty insights state */
.insights-empty {
    text-align: center;
    padding: 2.5rem 1rem;
    color: #7f8c8d;
}

.insights-empty-icon { font-size: 3rem; display:block; margin-bottom:1rem; }
.insights-empty p    { font-size:1rem; margin-bottom:0.5rem; }
.insights-empty-sub  { font-size:0.875rem; opacity:0.75; }

/* ============================================================
   PATTERNS, SUGGESTION, SUMMARY (unchanged from Iteration 5)
   ============================================================ */
.patterns-section { margin-bottom: 3rem; }
.patterns-list    { display:flex; flex-direction:column; gap:1rem; margin-top:1.5rem; }

.pattern-card {
    background:white; padding:1.25rem; border-radius:8px;
    border-left:4px solid #4A90E2;
    box-shadow:0 2px 4px rgba(0,0,0,0.05);
}

.pattern-card.pattern-warning { border-left-color:#F0AD4E; background:rgba(240,173,78,.05); }
.pattern-card.pattern-success { border-left-color:#5CB85C; background:rgba(92,184,92,.05); }
.pattern-card.pattern-info    { border-left-color:#5BC0DE; background:rgba(91,192,222,.05); }

.pattern-message { color:#2C3E50; font-size:1rem; line-height:1.5; }

.suggestion-section { margin-bottom:3rem; }

.suggestion-card {
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:white; padding:2rem; border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15); margin-top:1.5rem;
}

.suggestion-text { font-size:1.2rem; line-height:1.6; margin:0; }

.summary-section { margin-bottom:3rem; }

.summary-grid {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:1.5rem; margin-top:1.5rem;
}

.summary-item {
    background:white; padding:1.5rem; border-radius:8px;
    box-shadow:0 2px 4px rgba(0,0,0,0.05); text-align:center;
}

.summary-label { font-size:.875rem; color:#7F8C8D; margin-bottom:.5rem; }
.summary-value { font-size:1.75rem; font-weight:700; color:#4A90E2; }

.analytics-actions {
    display:flex; gap:1rem; justify-content:center; margin-top:3rem;
}

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media (max-width: 768px) {
    .analytics-grid { grid-template-columns: 1fr; }
    .tod-grid       { grid-template-columns: 1fr; }
    .tod-stats-row  { gap: 0.35rem; }
    .tod-stat       { min-width: 45px; }
    .insight-card   { flex-direction: column; gap: 0.75rem; }
    .insight-icon-wrap { flex-direction: row; min-width: unset; }
    .analytics-actions { flex-direction: column; }
    .analytics-actions .btn { width: 100%; text-align: center; }
    .period-selector { gap: 0.4rem; }
    .period-btn { padding: 0.4rem 0.9rem; font-size: 0.8rem; }
    .insights-header-row { flex-wrap: wrap; }
}
</style>
{% endblock %}


{% block extra_scripts %}
{% if tod_chart.labels %}
<script>
// ============================================================
// US-27: TIME-OF-DAY TIR comparison chart
// ============================================================
(function() {
    const ctx = document.getElementById('todChart');
    if (!ctx) return;

    const labels = {{ tod_chart.labels | tojson }};
    const tir    = {{ tod_chart.tir    | tojson }};
    const hypo   = {{ tod_chart.hypo   | tojson }};
    const hyper  = {{ tod_chart.hyper  | tojson }};
    const colors = {{ tod_chart.colors | tojson }};

    new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Time in Range (%)',
                    data: tir,
                    backgroundColor: colors,
                    borderColor: colors.map(c => c.replace('0.8', '1')),
                    borderWidth: 2,
                    borderRadius: 6,
                },
                {
                    label: 'Below Range (%)',
                    data: hypo,
                    backgroundColor: 'rgba(217, 83, 79, 0.5)',
                    borderColor: 'rgba(217, 83, 79, 0.9)',
                    borderWidth: 1,
                    borderRadius: 4,
                },
                {
                    label: 'Above Range (%)',
                    data: hyper,
                    backgroundColor: 'rgba(240, 173, 78, 0.4)',
                    borderColor: 'rgba(240, 173, 78, 0.9)',
                    borderWidth: 1,
                    borderRadius: 4,
                },
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { font: { size: 13 }, color: '#2C3E50' }
                },
                tooltip: {
                    backgroundColor: 'rgba(44,62,80,0.92)',
                    padding: 12,
                    callbacks: {
                        label: function(ctx) {
                            return ` ${ctx.dataset.label}: ${ctx.raw}%`;
                        }
                    }
                },
            },
            scales: {
                x: {
                    ticks: { color: '#7F8C8D', font: { size: 13 } },
                    grid: { display: false },
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        color: '#7F8C8D',
                        font: { size: 12 },
                        callback: v => v + '%'
                    },
                    grid: { color: 'rgba(0,0,0,0.05)' },
                }
            }
        }
    });
})();
</script>
{% endif %}
{% endblock %}
